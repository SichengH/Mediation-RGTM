install.packages("tidyr")
install.packages("ggplot2")
install.packages("data.table")
install.packages("Rcpp")
install.packages("survival")
install.packages("devtools")
simulation.function.v5<-function(sample.size = 20000,cutoff = 1000){
n<-sample.size/2
osp = 2
n0<-0
n1<-0
data0<-NULL
data1<-NULL
#control arm
for(i in 1:100){
#print(i)
if(n0<n){
ldlcm=rnorm(n = n*osp,mean = 116,sd = 14.2)#mean distribution of LDLC
d0<-data.frame(ldlcm,ldlcb=rnorm(n = n*osp,mean = ldlcm,sd = 16))
d0<-d0%>%filter(ldlcb<cutoff)
data0<-rbind(data0,d0)
n0<-nrow(data0)
} else {
break
}
}
data0<-data0[1:n,]
#data0$ldlc12m<-data0$ldlcm+rnorm(n,0,10)#12m has higher variacne then ldlcm due to possible life style change after entering the trial
data0$ldlc12<-rnorm(n = n,mean = data0$ldlcm,sd = 16)
#treatment arm
for(i in 1:100){
#print(i)
if(n1<n){
ldlcm=rnorm(n = n*osp,mean = 116,sd = 14.2)
d1<-data.frame(ldlcm,ldlcb=rnorm(n = n*osp,mean = ldlcm,sd = 16))
d1<-d1%>%filter(ldlcb<cutoff)
data1<-rbind(data1,d1)
n1<-nrow(data1)
} else {
break
}
}
data1<-data1[1:n,]
data1$ldlc12<-data1$ldlcm - 47 + rnorm(n,0,16)
data0$drug = 0
data1$drug = 1
data = rbind(data0,data1)
data<-data%>%mutate(ldlc_change = ldlc12 - ldlcb)
return(data)
}
source('~/Documents/GitHub/Mediation-RGTM/Adjust_RTM_v2.R')
library(ggplot2)
library(dplyr)
library(data.table)
library(survival)
library(regmedint)
install.packages("devtools") # If you do not have devtools already.
devtools::install_github("kaz-yos/regmedint")
source('~/Documents/GitHub/Mediation-RGTM/Adjust_RTM_v2.R')
library(ggplot2)
library(dplyr)
library(data.table)
library(survival)
library(DiagrammeR)
library(ggridges)
library(tidyr)
rd.11<-fread("v2-4.csv")
#rd.10<-fread("rd10.csv")
#e1 biased
#e2 gound truth
#e3 adjusted
# rd.10$cutoff<-as.factor(rd.10$cutoff)
# levels(rd.10$cutoff)[5]<-"No cutoff"
# rd.10$cutoff.n<-as.numeric(rd.10$cutoff)
rd.11$cutoff<-as.factor(rd.11$cutoff)
levels(rd.11$cutoff)[5]<-"No cutoff"
rd.11$cutoff.n<-as.numeric(rd.11$cutoff)
data<-rd.11%>%
transmute(cutoff,interaction = e1.te,no.inter = e2.te, adjusted = e3.te)%>%
gather("method","Prop.Mediated",-cutoff)
data$cutoff<-as.factor(data$cutoff)
levels(data$cutoff)[5]<-"No cutoff"
data$cutoff.n<-as.numeric(data$cutoff)
ggplot(data = data, aes(x = Prop.Mediated, y = cutoff.n, fill = cutoff)) +
geom_density_ridges(alpha = 0.5)+
facet_wrap(~method)+
scale_y_discrete(limit = c(1:10),labels = data$cutoff)+
coord_flip()+
theme(legend.position = "bottom",axis.text.x = element_blank(),
axis.title.x=element_blank())+
xlab("Mediator on Outcome")+
ggtitle("Total Effect from Package")
data<-rd.11%>%
transmute(cutoff,interaction = e1.te2,no.inter = e2.te2, adjusted = e3.te2)%>%
gather("method","Prop.Mediated",-cutoff)
data$cutoff<-as.factor(data$cutoff)
levels(data$cutoff)[5]<-"No cutoff"
data$cutoff.n<-as.numeric(data$cutoff)
ggplot(data = data, aes(x = Prop.Mediated, y = cutoff.n, fill = cutoff)) +
geom_density_ridges(alpha = 0.5)+
facet_wrap(~method)+
scale_y_discrete(limit = c(1:10),labels = data$cutoff)+
coord_flip()+
theme(legend.position = "bottom",axis.text.x = element_blank(),
axis.title.x=element_blank())+
xlab("Mediator on Outcome")+
ggtitle("Total Effect from regression")
library(ggplot2)
library(dplyr)
library(data.table)
library(survival)
library(DiagrammeR)
library(regmedint)
#Set Up
p<<-1.4
#outcome regression AFT
theta0<<-7.5
theta1<<-0.0  #direct effect, positive is protective
theta2<<--0.015  #effect * ldlc_change; negative is protective
theta3<<-0 # ldlc_change * drug assume no effect
theta4<<--0.02 # cov
# theta0_ni<<-7.7
# theta1_ni<<-0.59
# theta2_ni<<-0.0032 #should be negative
cutoff<-c(90,110,130,150,1000)
#
data<-simulation.function.v4(20000,cutoff = cutoff[5])
source('~/Documents/GitHub/Mediation-RGTM/functions.R')
#
data<-simulation.function.v4(20000,cutoff = cutoff[5])
data$ldlc_change<-data$ldlc12 - data$ldlcb
data$ldlc_change_m<-data$ldlc12m - data$ldlcm
data0<-data%>%filter(drug == 0)
data1<-data%>%filter(drug == 1)
data$cen<-rep(1,20000)
data$y1<-rweibull(20000,shape = 1/p,scale = exp(theta0+theta1*data$drug+
theta2*data$ldlc_change_m+
theta3*data$ldlc_change_m*data$drug+
theta4*data$ldlcb))
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc12",
cvar = c("ldlcb"),
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = 120,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change",
cvar = c("ldlcb"),
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = 120,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change_m",
cvar = c("ldlcb"),
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = 120,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change",
cvar = c("ldlcb"),
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = 120,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
#explore
plot(data$ldlc_change,data$ldlc_change_m)
#explore
ggplot(data) + geom_point((aes(x = ldlc_change,y = ldlc_change_m,col = drug)))
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change",
cvar = 0,
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = NULL,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change",
cvar = NULL,
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = NULL,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
#explore
ggplot(data) + geom_point((aes(x = ldlcb,y = ldlc_change_m,col = drug)))
#explore
ggplot(data) + geom_point((aes(x = ldlcb,y = ldlc_change,col = drug)))
ggplot(data) + geom_point((aes(x = ldlcb,y = ldlc_change_m,col = drug)))
fit1<-regmedint(data = data,
## Variables
yvar = "y1",
avar = "drug",
mvar = "ldlc_change",
cvar = c("ldlcb"),
eventvar = "cen",
## Values at which effects are evaluated
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = 120,
## Model types
mreg = "linear",
#yreg = "survCox",
yreg = "survAFT_weibull",
## Additional specification
interaction = TRUE,
casecontrol = FALSE)
summ<-summary(fit1)
summ
ldlcb.to.outcome<-survreg(Surv(y1,cen)~ldlcb,data = data,dist = "weibull")
ldlcb.to.outcome
summary(ldlcb.to.outcome)
block.all<-survreg(Surv(y1,cen)~ldlc_change,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~ldlc_change+drug,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~ldlc_change+drug+ldlc_change_m,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~drug+ldlc_change_m,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~drug+ldlc_change_m+ldlcb,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~drug+ldlc_change+ldlcb,data = data,dist = "weibull")
summary(block.all)
data$y1<-rweibull(20000,shape = 1/p,scale = exp(theta0+theta1*data$drug+
theta2*data$ldlc_change_m+
theta3*data$ldlc_change_m*data$drug
#theta4*data$ldlcb
))
#explore
ggplot(data) + geom_point((aes(x = ldlcb,y = ldlc_change,col = drug)))#negative
ggplot(data) + geom_point((aes(x = ldlcb,y = ldlc_change_m,col = drug)))#no relation
ldlcb.to.outcome<-survreg(Surv(y1,cen)~ldlcb,data = data,dist = "weibull")
summary(ldlcb.to.outcome)
block.all<-survreg(Surv(y1,cen)~drug+ldlc_change+ldlcb,data = data,dist = "weibull")
summary(block.all)
block.all<-survreg(Surv(y1,cen)~drug+ldlc_change_m+ldlcb,data = data,dist = "weibull")
summary(block.all)
library(tinytex)
update.packages(ask = FALSE, checkBuilt = TRUE)
tinytex::tlmgr_update()
options(tinytex.verbose = TRUE)
latexmk()
tinytex::install_tinytex()
m.fit<-lm(data = data,ldlc_change~ldlcb+drug)
m.fit
data$ldlc_change_adj<-predict(m.fit,newdata = data)
plot(data$ldlc_change_adj,data$ldlc_change)
plot(data$ldlc_change_adj,data$ldlcb)
data0<-data%>%filter(drug==0)
mean(data0$ldlc_change_adj)
hist(dara0$ldlc_change_adj)
hist(data0$ldlc_change_adj)
hist(data0$ldlc_change)
mena(data0$ldlc_change)
mean(data0$ldlc_change)
m.fit<-lm(data = data,ldlc_change~ldlcb+drug)
data$ldlc_change_adj<-predict(m.fit,newdata = data)
#Set Up
p<<-1.4
#outcome regression AFT
theta0<<-7.5
theta1<<-0.0  #direct effect, positive is protective
theta2<<--0.015  #effect * ldlc_change; negative is protective
theta3<<-0 # ldlc_change * drug assume no effect
theta4<<--0.02 # cov
# theta0_ni<<-7.7
# theta1_ni<<-0.59
# theta2_ni<<-0.0032 #should be negative
cutoff<-c(90,110,130,150,1000)
#
data<-simulation.function.v4(20000,cutoff = cutoff[5])
data$ldlc_change<-data$ldlc12 - data$ldlcb
data$ldlc_change_m<-data$ldlc12m - data$ldlcm
m.fit<-lm(data = data,ldlc_change~ldlcb+drug)
data$ldlc_change_adj<-predict(m.fit,newdata = data)
m.fit
# theta0_ni<<-7.7
# theta1_ni<<-0.59
# theta2_ni<<-0.0032 #should be negative
cutoff<-c(90,110,130,150,1000)
#
data<-simulation.function.v4(20000,cutoff = cutoff[3])
data$ldlc_change<-data$ldlc12 - data$ldlcb
data$ldlc_change_m<-data$ldlc12m - data$ldlcm
data$cen<-rep(1,20000)
m.fit<-lm(data = data,ldlc_change~ldlcb+drug)
data$ldlc_change_adj<-predict(m.fit,newdata = data)
m.fit
data0<-data%>%filter(drug==0)
mean(data0$ldlc_change)
mean(data0$ldlc_change_adj)
m.fit<-lm(data = data,ldlc_change~ldlcb+drug)
data$ldlc_change_adj<-predict(m.fit,newdata = data)
m.fit
data$ldlc_change_adj<-predict(m.fit,newdata = data)
m.fit<-lm(data = data0,ldlc12m~ldlcb)
m.fit
m.fit<-lm(data = data0,ldlc_change~ldlcb)
m.fit
m.fit$coefficients
m.fit$coefficients[2]
m.fit<-lm(data = data0,ldlc_change~ldlcb)
data$ldlc_change_adj<-data$ldlc_chage - data$ldlcb * m.fit$coefficients[2] - m.fit$coefficients[1]
m.fit<-lm(data = data0,ldlc_change~ldlcb)
data$ldlc_change_adj<-data$ldlc_chage - data$ldlcb * m.fit$coefficients[2] - m.fit$coefficients[1]
m.fit$coefficients[1]
m.fit$coefficients[1]+1
data$ldlc_change_adj<-data$ldlc_chage - data$ldlcb * m.fit$coefficients[2] - m.fit$coefficients[1]
data$ldlc_change_adj<-data$ldlc_chage -
data$ldlcb * m.fit$coefficients[2] -
rep(m.fit$coefficients[1],nrow(data))
data$ldlc_chage
data$ldlc_change_adj<-data$ldlc_change -
data$ldlcb * m.fit$coefficients[2] -
rep(m.fit$coefficients[1],nrow(data))
ggplot(data,aes(x = ldlcb,y = ldlc_change_adj,col = drug))+
geom_point(alpha = 0.1)+
geom_smoth(method= "lm")
ggplot(data,aes(x = ldlcb,y = ldlc_change_adj,col = drug))+
geom_point(alpha = 0.1)+
geom_smooth(method= "lm")
source('~/Documents/GitHub/Mediation-RGTM/Adjust_RTM_v2.R')
simulation.function.v43<-function(sample.size = 20000,cutoff = 1000){
n<-sample.size/2
osp = 2
n0<-0
n1<-0
data0<-NULL
data1<-NULL
#control arm
for(i in 1:100){
#print(i)
if(n0<n){
ldlcm=rnorm(n = n*osp,mean = 116,sd = 14.2)#mean distribution of LDLC
d0<-data.frame(ldlcm,ldlcb=rnorm(n = n*osp,mean = ldlcm,sd = 16))
d0<-d0%>%filter(ldlcb<cutoff)
data0<-rbind(data0,d0)
n0<-nrow(data0)
} else {
break
}
}
data0<-data0[1:n,]
data0$ldlc12m<-data0$ldlcm+rnorm(n,0,10)#12m has higher variance then ldlcm due to possible life style change after entering the trial
data0$ldlc121<-data0$ldlc12m+rnorm(n,0,12)#add variance of rgtm
data0$ldlc122<-data0$ldlc12m+rnorm(n,0,12)#add variance of rgtm
data0$ldlc123<-data0$ldlc12m+rnorm(n,0,12)#add variance of rgtm
#treatment arm
for(i in 1:100){
#print(i)
if(n1<n){
ldlcm=rnorm(n = n*osp,mean = 116,sd = 14.2)
d1<-data.frame(ldlcm,ldlcb=rnorm(n = n*osp,mean = ldlcm,sd = 16))
d1<-d1%>%filter(ldlcb<cutoff)
data1<-rbind(data1,d1)
n1<-nrow(data1)
} else {
break
}
}
data1<-data1[1:n,]
data1$ldlc12m<-data1$ldlcm - 47 + rnorm(n,0,10)
data1$ldlc121<-data1$ldlc12m+rnorm(n,0,sd = 12)
data1$ldlc122<-data1$ldlc12m+rnorm(n,0,sd = 12)
data1$ldlc123<-data1$ldlc12m+rnorm(n,0,sd = 12)
data0$drug = 0
data1$drug = 1
data = rbind(data0,data1)
data<-data%>%mutate(ldlc12 = (ldlc121+ldlc122+ldlc123)/3)
#data<-data%>%mutate(ldlc_change = ldlc12 - ldlcb,ldlc_change.m = ldlc12m - ldlcb)
return(data)
}
source('~/Documents/GitHub/Mediation-RGTM/Adjust_RTM_v3.R')
